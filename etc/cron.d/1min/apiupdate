#!/usr/bin/php
<?php

include ('miner.inc.php');
include ('settings.inc.php');

// If the api is not enabled, do nothing

if ($settings['apiEnable'] != false) {

  if ($settings['apiKey'] == "") {
    // No api key, get one
    $settings['apiKey'] = file_get_contents($settings['apiURL'] . "?k=");
    writeSettings($settings);
  }


  $hostsipaddress = str_replace("\n","",shell_exec("ifconfig eth0 | grep 'inet addr' | awk -F':' {'print $2'} | awk -F' ' {'print $1'}"));


  // All api updates should start with the api key of the device

  // Api Key
  $api_update = "?k=" . $settings['apiKey'];
  // Hashrate
  $api_update .= "&h=" . $settings['current_hashrate'];
  // Local IP
  $api_update .= "&l_ip=" . $hostsipaddress;
  // Version
  $api_update .= "&v=" . $version;
  // TimeZone
  $api_update .= "&tz=" . $settings['userTimezone'];


  // Wait between 0 and 59 seconds....
  sleep(mt_rand(0,59));

  // Update the API and save it's responce
  $apiResponce = file_get_contents($settings['apiURL'] . $api_update);
  $settings['apiResponce'] = $apiResponce;
  writeSettings($settings);
  
}
